## attach-volume
#
# Attach the EBS volume, and partition if necessary.

declare -i attempt=24

# Get a random device letter, we will hang forever if we try to attach
# a volume to an already mapped device.
for device_letter in {f..z}
do
    block_device_path="/dev/xvd${device_letter}"
    [ ! -b "${block_device_path}" ] && break
done

if [ -b "${block_device_path}" ]
then
    die "No free device letters found (tried xvdf to xvdz)!"
fi

# Wait until the volume has a status of 'available' before attempting
# to attach to ensure success.
while [ ${attempt} -ne 0 -a "$(aws --output json \
    ec2 describe-volumes \
    --volume-ids "${volume_id}" | \
    jq -e -r '.Volumes[0].State')" != "available" ]
do
    sleep 5
    (( --attempt ))
done

if [ ${attempt} -eq 0 ]
then
    die "It seems we were unable to create ${volume_id}."
fi

aws ec2 attach-volume --volume-id "${volume_id}" \
    --instance-id "${instance_id}" \
    --device "/dev/xvd${device_letter}" >/dev/null

# Wait until the volume is attached
dotdot "test -b ${block_device_path} && echo attached"

# Partition the block device.
if [ "${partitioning}" != "none" ]
then
    parted -s "${block_device_path}" mktable "${partitioning}"
    parted -s -a optimal "${block_device_path}" mkpart primary ext4 1Mi 100%
    parted -s "${block_device_path}" set 1 boot on
    hdparm -z "${block_device_path}"
    fs_device_path="${block_device_path}1"
else
    fs_device_path="${block_device_path}"
fi
